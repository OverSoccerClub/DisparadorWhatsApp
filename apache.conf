# Configuração Apache para WhatsApp Dispatcher
# Otimizada para produção com cache, compressão e segurança

<VirtualHost *:80>
    ServerName seu-dominio.com
    ServerAlias www.seu-dominio.com
    
    # Redirecionar HTTP para HTTPS
    Redirect permanent / https://seu-dominio.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName seu-dominio.com
    ServerAlias www.seu-dominio.com
    
    # Configurações SSL
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # Configurações de segurança
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Content-Type-Options "nosniff"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'"
    
    # Compressão
    LoadModule deflate_module modules/mod_deflate.so
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
    
    # Cache para arquivos estáticos
    <LocationMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, immutable"
        Header set Vary "Accept-Encoding"
    </LocationMatch>
    
    # Proxy para Next.js
    ProxyPreserveHost On
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/
    
    # Configurações de proxy
    ProxyTimeout 60
    ProxyPassReverse / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/
    
    # Logs
    ErrorLog /var/log/apache2/whatsapp-dispatcher.error.log
    CustomLog /var/log/apache2/whatsapp-dispatcher.access.log combined
    
    # Configurações de performance
    Timeout 60
    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5
</VirtualHost>

# Configuração adicional para múltiplos workers (opcional)
# <Proxy balancer://nextjs_cluster>
#     BalancerMember http://localhost:3000
#     BalancerMember http://localhost:3001
#     BalancerMember http://localhost:3002
# </Proxy>
